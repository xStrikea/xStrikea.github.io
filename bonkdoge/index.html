<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Bonkdoge - Click Doge and Compete Globally!</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="image/logo.png" type="image/x-icon" />
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap');
  /* Reset & base */
  html, body {
    margin: 0; padding: 0;
    height: 100%;
    background: url('image/background.png') no-repeat center center fixed;
    background-size: cover;
    font-family: 'Poppins', sans-serif;
    user-select: none;
    overflow-x: hidden;
    -webkit-tap-highlight-color: transparent;
  }
  /* 頂部容器 */
  #header {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 60px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: flex-start; /* 左靠齊 */
    padding: 0 1rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 30;
    gap: 0.6rem;
  }
  #header img {
    width: 32px; height: 32px;
    user-select: none;
  }
  #header h1 {
    margin: 0;
    font-size: 1.5rem;
    color: black;
    font-weight: 700;
    user-select: none;
  }
  #header p {
    margin: 0;
    font-weight: 600;
    color: black;
    user-select: none;
    font-size: 0.9rem;
  }
  /* 主內容容器 */
  .content {
    position: relative;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 70px 1rem 0 1rem; /* 預留 header 高度 */
  }
  #counter {
    font-size: clamp(3rem, 8vw, 6rem);
    color: white;
    text-shadow: 0 4px 8px rgba(0,0,0,0.5);
    margin-top: 1rem;
    user-select: none;
  }
  #bonkdoge {
    width: 85vw;
    max-width: 700px;
    margin-top: 2rem;
    border-radius: 20px;
    box-shadow: 0 15px 25px rgba(0,0,0,0.25);
    cursor: pointer;
    transition: transform 0.15s;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }
  #bonkdoge:active {
    transform: scale(0.95);
  }
  /* 底部排版 */
  #leaderbar {
    position: fixed;
    bottom: 0;
    left: 0; right: 0;
    background: rgba(255,255,255,0.95);
    box-shadow: 0 -4px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    z-index: 25;
  }
  #leaderbar .left {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    user-select: none;
  }
  #leaderbar .flag {
    font-size: 1.2rem;
  }
  #toggleBtn {
    border: none;
    background: none;
    font-size: 1.4rem;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    outline: none !important;
    user-select: none;
    padding: 0.2rem 0.5rem;
    transition: transform 0.2s ease;
    user-select: none;
  }
  #toggleBtn:focus {
    outline: none;
  }
  #toggleBtn:hover {
    transform: rotate(180deg);
  }
  /* 排行榜視窗 */
  #leaderboard {
    position: fixed;
    bottom: 3.8rem; /* 預留leaderbar高度 + margin */
    left: 0; right: 0;
    max-height: 55vh;
    overflow-y: auto;
    background: white;
    border-top-left-radius: 24px;
    border-top-right-radius: 24px;
    box-shadow: 0 -6px 16px rgba(0,0,0,0.15);
    padding: 1rem 2rem;
    z-index: 24;
    user-select: none;
    transform: translateY(100%);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }
  #leaderboard.show {
    transform: translateY(0);
    opacity: 1;
  }
  #leaderboard h2 {
    margin-top: 0;
    font-size: 1.5rem;
    text-align: center;
    user-select: none;
  }
  #topScores {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #topScores li {
    padding: 0.6rem 1rem;
    margin-bottom: 0.5rem;
    background: #f1f5f9;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    font-weight: 600;
    user-select: none;
  }
</style>
</head>
<body>

  <div id="header">
    <img src="image/logo.png" alt="logo" draggable="false" />
    <h1>Bonkdoge</h1>
    <p>Beta</p>
  </div>

  <div class="content">
    <div id="counter">0</div>
    <img id="bonkdoge" src="image/doge.png" alt="Bonkdoge" draggable="false" />
  </div>

  <div id="leaderbar">
    <div class="left">
      🏆
      <span class="flag" id="top1">1nd</span>
      <p>•</p>
      <span class="flag" id="top2">️2nd</span>
      <p>•</p>
      <span class="flag" id="top3">3nd</span>
    </div>
    <button id="toggleBtn" aria-label="Toggle leaderboard">↑</button>
  </div>

  <div id="leaderboard" role="region" aria-live="polite" aria-label="Global Rankings">
    <h2>🌐 Global Rankings</h2>
    <ul id="topScores">Loading...</ul>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, update, get, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqsj5CkvEP_7MqQmYESgDnsz-VSTimhdw",
      authDomain: "xsweb-6f858.firebaseapp.com",
      databaseURL: "https://xsweb-6f858-default-rtdb.firebaseio.com",
      projectId: "xsweb-6f858",
      storageBucket: "xsweb-6f858.appspot.com",
      messagingSenderId: "599529998192",
      appId: "1:599529998192:web:63c64ed7dcc5208d5971b5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const bonkdoge = document.getElementById("bonkdoge");
    const counter = document.getElementById("counter");
    const leaderboard = document.getElementById("leaderboard");
    const leaderboardList = document.getElementById("topScores");
    const toggleBtn = document.getElementById("toggleBtn");

    const top1 = document.getElementById("top1");
    const top2 = document.getElementById("top2");
    const top3 = document.getElementById("top3");

    const closed = "image/doge.png";
    const open = "image/doge_open.png";

    let uid = null;
    let count = 0;
    let country = "Unknown";
    let code = "";
    let canClick = true;
    let ready = false;
    let openTimeout = null;

    function codeToFlagEmoji(code) {
      if (!code) return "";
      return code.toUpperCase().replace(/./g, c => String.fromCodePoint(c.charCodeAt(0) + 127397));
    }

    async function fetchCountryInfo() {
      try {
        const res = await fetch("https://ipapi.co/json/");
        const data = await res.json();
        return { country: data.country_name || "Unknown", code: data.country_code || "" };
      } catch {
        return { country: "Unknown", code: "" };
      }
    }

    function pop() {
      if (!ready || !canClick) return;
      canClick = false;

      count++;
      counter.textContent = count;

      bonkdoge.src = open;
      const newAudio = new Audio("audio/bonk.mp3");
      newAudio.play();

      if (openTimeout) clearTimeout(openTimeout);
      openTimeout = setTimeout(() => {
        bonkdoge.src = closed;
        openTimeout = null;
      }, 500);

      if (uid) {
        update(ref(db, "scores/" + uid), {
          score: count,
          country: country,
          code: code,
          timestamp: Date.now()
        });
      }

      setTimeout(() => { canClick = true; }, 100);
    }

    function updateLeaderboard() {
      const topRef = ref(db, "scores");
      onValue(topRef, (snapshot) => {
        const countryScores = {};
        snapshot.forEach(child => {
          const val = child.val();
          const key = (val.country || "Unknown") + "|" + (val.code || "");
          if (!countryScores[key]) {
            countryScores[key] = { score: 0, name: val.country, code: val.code };
          }
          countryScores[key].score += val.score || 0;
        });

        const sorted = Object.values(countryScores).sort((a, b) => b.score - a.score);
        top1.textContent = codeToFlagEmoji(sorted[0]?.code) + " " + (sorted[0]?.code || "1nd");
        top2.textContent = codeToFlagEmoji(sorted[1]?.code) + " " + (sorted[1]?.code || "2nd");
        top3.textContent = codeToFlagEmoji(sorted[2]?.code) + " " + (sorted[2]?.code || "3nd");

        leaderboardList.innerHTML = sorted.map(entry =>
          `<li><span>${codeToFlagEmoji(entry.code)} ${entry.name}</span><span>${entry.score}</span></li>`
        ).join('');
      });
    }

    toggleBtn.addEventListener("click", () => {
      leaderboard.classList.toggle("show");
      toggleBtn.textContent = leaderboard.classList.contains("show") ? "↓" : "↑";
    });

    bonkdoge.addEventListener("mousedown", pop);
    bonkdoge.addEventListener("touchstart", pop);

    signInAnonymously(auth).then(async () => {
      const info = await fetchCountryInfo();
      country = info.country;
      code = info.code;

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          uid = user.uid;

          const userRef = ref(db, "scores/" + uid);
          get(userRef).then(snapshot => {
            if (snapshot.exists()) {
              count = snapshot.val().score || 0;
              counter.textContent = count;
            } else {
              update(userRef, { score: 0, country: country, code: code, timestamp: Date.now() });
            }
            updateLeaderboard();
            ready = true;
          });
        }
      });
    });
  </script>

</body>
</html>