<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Bonkdoge - Click Doge and Compete Globally!</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="image/logo.png" type="image/x-icon" />
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap');
  /* Reset & base */
  html, body {
    margin: 0; padding: 0;
    height: 100%;
    background: url('image/background.png') no-repeat center center fixed;
    background-size: cover;
    font-family: 'Poppins', sans-serif;
    user-select: none;
    overflow-x: hidden;
    -webkit-tap-highlight-color: transparent;
  }
  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 60px;
    background: rgba(255,255,255,0.95);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    user-select: none;
    z-index: 30;
  }
  header h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.8rem;
    color: #222;
  }
  #nav-buttons {
    display: flex;
    gap: 1rem;
  }
  #nav-buttons button {
    background: transparent;
    border: none;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    color: #007bff;
    transition: color 0.2s ease;
  }
  #nav-buttons button:hover {
    color: #0056b3;
  }
  #logoutBtn {
    background: #d33;
    border: none;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    padding: 0.35rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #logoutBtn:hover {
    background: #a00;
  }
  main {
    height: 100%;
    padding-top: 70px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }
  /* Âç°ÁâåË°®ÂñÆ */
  .card {
    background: rgba(255,255,255,0.95);
    border-radius: 16px;
    box-shadow: 0 12px 32px rgba(0,0,0,0.12);
    width: 350px;
    max-width: 90vw;
    padding: 2rem;
    user-select: none;
  }
  h2 {
    margin-top: 0;
    font-weight: 700;
    font-size: 1.6rem;
    text-align: center;
    color: #222;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
  }
  input[type="email"],
  input[type="password"] {
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    transition: border-color 0.3s ease;
  }
  input[type="email"]:focus,
  input[type="password"]:focus {
    border-color: #007bff;
    outline: none;
  }
  button.submit-btn {
    padding: 0.85rem;
    font-weight: 700;
    font-size: 1.1rem;
    background: #007bff;
    border: none;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button.submit-btn:hover {
    background: #0056b3;
  }
  .switch-text {
    margin-top: 1rem;
    text-align: center;
    font-size: 0.95rem;
    color: #555;
    user-select: none;
  }
  .switch-text span {
    color: #007bff;
    cursor: pointer;
    display: inline-block;
    margin-top: 0.2rem;
    font-weight: 600;
  }
  .error-message {
    color: #d93025;
    font-weight: 600;
    font-size: 0.9rem;
    text-align: center;
  }
  /* ÈÅäÊà≤‰∏ªÁïåÈù¢ */
  #game-container {
    display: none;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 720px;
    padding: 0 1rem;
    position: relative;
    z-index: 10;
  }
  #counter {
    font-size: clamp(3rem, 8vw, 6rem);
    color: white;
    text-shadow: 0 4px 8px rgba(0,0,0,0.5);
    margin-top: 2rem;
    user-select: none;
  }
  #bonkdoge {
    width: 85vw;
    max-width: 700px;
    margin-top: 2rem;
    border-radius: 20px;
    box-shadow: 0 15px 25px rgba(0,0,0,0.25);
    cursor: pointer;
    transition: transform 0.15s;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }
  #bonkdoge:active {
    transform: scale(0.95);
  }
  /* Â∫ïÈÉ®ÊéíÁâà */
  #leaderbar {
    position: fixed;
    bottom: 0;
    left: 0; right: 0;
    background: rgba(255,255,255,0.95);
    box-shadow: 0 -4px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    z-index: 25;
  }
  #leaderbar .left {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    user-select: none;
  }
  #leaderbar .flag {
    font-size: 1.2rem;
  }
  #toggleBtn {
    border: none;
    background: none;
    font-size: 1.4rem;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    outline: none !important;
    user-select: none;
    padding: 0.2rem 0.5rem;
    transition: transform 0.2s ease;
  }
  #toggleBtn:focus {
    outline: none;
  }
  #toggleBtn:hover {
    transform: rotate(180deg);
  }
  /* ÊéíË°åÊ¶úË¶ñÁ™ó */
  #leaderboard {
    position: fixed;
    bottom: 3.8rem; /* È†êÁïôleaderbarÈ´òÂ∫¶ + margin */
    left: 0; right: 0;
    max-height: 55vh;
    overflow-y: auto;
    background: white;
    border-top-left-radius: 24px;
    border-top-right-radius: 24px;
    box-shadow: 0 -6px 16px rgba(0,0,0,0.15);
    padding: 1rem 2rem;
    z-index: 24;
    user-select: none;
    transform: translateY(100%);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }
  #leaderboard.show {
    transform: translateY(0);
    opacity: 1;
  }
  #leaderboard h2 {
    margin-top: 0;
    font-size: 1.5rem;
    text-align: center;
    user-select: none;
  }
  #topScores {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #topScores li {
    padding: 0.6rem 1rem;
    margin-bottom: 0.5rem;
    background: #f1f5f9;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    font-weight: 600;
    user-select: none;
  }
</style>
</head>
<body>

<header>
  <h1>Bonkdoge</h1>
  <div id="nav-buttons">
    <button id="btn-login" aria-label="Switch to Login" style="display:none;">Login</button>
    <button id="btn-register" aria-label="Switch to Register" style="display:none;">Register</button>
  </div>
  <button id="logoutBtn" style="display:none;">Logout</button>
</header>

<main>
  <!-- ÁôªÂÖ•/Ë®ªÂÜäÂç°Áâå -->
  <div class="card" id="login-card">
    <h2>Login</h2>
    <form id="login-form" autocomplete="off">
      <input type="email" id="login-email" placeholder="Email" required />
      <input type="password" id="login-password" placeholder="Password" required minlength="6" />
      <button type="submit" class="submit-btn">Login</button>
      <div class="error-message" id="login-error"></div>
    </form>
    <div class="switch-text">
      Don't have an account?<br />
      <span id="to-register">Register</span>
    </div>
  </div>

  <div class="card" id="register-card" style="display:none;">
    <h2>Register</h2>
    <form id="register-form" autocomplete="off">
      <input type="email" id="register-email" placeholder="Email" required />
      <input type="password" id="register-password" placeholder="Password" required minlength="6" />
      <button type="submit" class="submit-btn">Register</button>
      <div class="error-message" id="register-error"></div>
    </form>
    <div class="switch-text">
      Already have an account?<br />
      <span id="to-login">Login</span>
    </div>
  </div>

  <!-- ÈÅäÊà≤‰∏ªÁïåÈù¢ -->
  <div id="game-container">
    <div id="counter">0</div>
    <img id="bonkdoge" src="image/doge.png" alt="Bonkdoge" draggable="false" />
    <div id="leaderbar">
      <div class="left">
        üèÜ
        <span class="flag" id="top1">1st</span>
        <p>‚Ä¢</p>
        <span class="flag" id="top2">2nd</span>
        <p>‚Ä¢</p>
        <span class="flag" id="top3">3rd</span>
      </div>
      <button id="toggleBtn" aria-label="Toggle leaderboard">‚Üë</button>
    </div>
    <div id="leaderboard" role="region" aria-live="polite" aria-label="Global Rankings">
      <h2>üåê Global Rankings</h2>
      <ul id="topScores">Loading...</ul>
    </div>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, update, get, onValue } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBqsj5CkvEP_7MqQmYESgDnsz-VSTimhdw",
    authDomain: "xsweb-6f858.firebaseapp.com",
    databaseURL: "https://xsweb-6f858-default-rtdb.firebaseio.com",
    projectId: "xsweb-6f858",
    storageBucket: "xsweb-6f858.appspot.com",
    messagingSenderId: "599529998192",
    appId: "1:599529998192:web:63c64ed7dcc5208d5971b5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  // DOM Elements
  const loginCard = document.getElementById("login-card");
  const registerCard = document.getElementById("register-card");
  const btnLogin = document.getElementById("btn-login");
  const btnRegister = document.getElementById("btn-register");
  const toRegister = document.getElementById("to-register");
  const toLogin = document.getElementById("to-login");
  const logoutBtn = document.getElementById("logoutBtn");

  const loginForm = document.getElementById("login-form");
  const registerForm = document.getElementById("register-form");
  const loginError = document.getElementById("login-error");
  const registerError = document.getElementById("register-error");

  const gameContainer = document.getElementById("game-container");
  const bonkdoge = document.getElementById("bonkdoge");
  const counter = document.getElementById("counter");
  const leaderboard = document.getElementById("leaderboard");
  const leaderboardList = document.getElementById("topScores");
  const toggleBtn = document.getElementById("toggleBtn");

  const top1 = document.getElementById("top1");
  const top2 = document.getElementById("top2");
  const top3 = document.getElementById("top3");

  const closedImg = "image/doge.png";
  const openImg = "image/doge_open.png";

  // State
  let count = 0;
  let country = "Unknown";
  let code = "";
  let canClick = true;
  let openTimeout = null;

  // Functions to toggle login/register forms
  function showLogin() {
    loginCard.style.display = "block";
    registerCard.style.display = "none";
  }
  function showRegister() {
    loginCard.style.display = "none";
    registerCard.style.display = "block";
  }
  btnLogin.addEventListener("click", showLogin);
  btnRegister.addEventListener("click", showRegister);
  toRegister.addEventListener("click", showRegister);
  toLogin.addEventListener("click", showLogin);

  // Show/hide login and register buttons in header (only when logged out)
  function showNavButtons(show) {
    btnLogin.style.display = show ? "inline-block" : "none";
    btnRegister.style.display = show ? "inline-block" : "none";
    logoutBtn.style.display = show ? "none" : "inline-block";
  }

  // Utility to convert country code to emoji flag
  function codeToFlagEmoji(code) {
    if (!code) return "";
    return code.toUpperCase().replace(/./g, c => String.fromCodePoint(c.charCodeAt(0) + 127397));
  }

  // Fetch user country info by IP
  async function fetchCountryInfo() {
    try {
      const res = await fetch("https://ipapi.co/json/");
      const data = await res.json();
      return { country: data.country_name || "Unknown", code: data.country_code || "" };
    } catch {
      return { country: "Unknown", code: "" };
    }
  }

  // bonkdoge click handler
  function pop() {
    if (!canClick) return;
    canClick = false;
    count++;
    counter.textContent = count;
    bonkdoge.src = openImg;
    new Audio("audio/bonk.mp3").play();

    if (openTimeout) clearTimeout(openTimeout);
    openTimeout = setTimeout(() => {
      bonkdoge.src = closedImg;
      openTimeout = null;
    }, 500);

    if (auth.currentUser) {
      update(ref(db, "scores/" + auth.currentUser.uid), {
        score: count,
        country: country,
        code: code,
        timestamp: Date.now()
      });
    }

    setTimeout(() => { canClick = true; }, 100);
  }

  // Update leaderboard from database
  function updateLeaderboard() {
    const topRef = ref(db, "scores");
    onValue(topRef, (snapshot) => {
      const countryScores = {};
      snapshot.forEach(child => {
        const val = child.val();
        const key = (val.country || "Unknown") + "|" + (val.code || "");
        if (!countryScores[key]) {
          countryScores[key] = { score: 0, name: val.country, code: val.code };
        }
        countryScores[key].score += val.score || 0;
      });

      const sorted = Object.values(countryScores).sort((a, b) => b.score - a.score);
      // ÊéíÂ∫èÂæåÈ°ØÁ§∫Ââç‰∏âÂêçÊóóÂπüÂèäÊéíË°åÊ¶úÂàóË°®
      top1.textContent = codeToFlagEmoji(sorted[0]?.code) + " " + (sorted[0]?.code || "1st");
      top2.textContent = codeToFlagEmoji(sorted[1]?.code) + " " + (sorted[1]?.code || "2nd");
      top3.textContent = codeToFlagEmoji(sorted[2]?.code) + " " + (sorted[2]?.code || "3rd");

      leaderboardList.innerHTML = sorted.map(entry =>
        `<li><span>${codeToFlagEmoji(entry.code)} ${entry.name}</span><span>${entry.score}</span></li>`
      ).join('');
    });
  }

  // ÂàáÊèõÊéíË°åÊ¶úÈ°ØÁ§∫ÊåâÈàïË°åÁÇ∫
  toggleBtn.addEventListener("click", () => {
    leaderboard.classList.toggle("show");
    toggleBtn.textContent = leaderboard.classList.contains("show") ? "‚Üì" : "‚Üë";
  });

  // bonkdoge ÈªûÊìä‰∫ã‰ª∂
  bonkdoge.addEventListener("mousedown", pop);
  bonkdoge.addEventListener("touchstart", pop);

  // Áõ£ËÅΩÁôªÂÖ•ÁãÄÊÖã
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // Â∑≤ÁôªÂÖ•ÔºåÈö±ËóèÁôªÂÖ•Ë®ªÂÜä‰ªãÈù¢ÔºåÈ°ØÁ§∫ÈÅäÊà≤‰ªãÈù¢
      loginCard.style.display = "none";
      registerCard.style.display = "none";
      gameContainer.style.display = "flex";
      showNavButtons(false); // Èö±ËóèÁôªÂÖ•Ë®ªÂÜäÊåâÈàïÔºåÈ°ØÁ§∫ÁôªÂá∫

      // ÂèñÂæóÂúãÂÆ∂Ë≥áË®ä
      const info = await fetchCountryInfo();
      country = info.country;
      code = info.code;

      // ËºâÂÖ•Áî®Êà∂ÂàÜÊï∏
      const userRef = ref(db, "scores/" + user.uid);
      const snapshot = await get(userRef);
      if (snapshot.exists()) {
        count = snapshot.val().score || 0;
        counter.textContent = count;
      } else {
        // Êñ∞Áî®Êà∂ÂàùÂßãÂåñ
        await update(userRef, { score: 0, country, code, timestamp: Date.now() });
        count = 0;
        counter.textContent = count;
      }
      updateLeaderboard();
    } else {
      // ÁôªÂá∫ÁãÄÊÖãÔºåÈ°ØÁ§∫ÁôªÂÖ•Âç°Áâå
      gameContainer.style.display = "none";
      loginCard.style.display = "block";
      registerCard.style.display = "none";
      showNavButtons(true);
      count = 0;
      counter.textContent = count;
    }
  });

  // ÁôªÂÖ•Ë°®ÂñÆÊèê‰∫§
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    loginError.textContent = "";
    const email = loginForm["login-email"].value.trim();
    const password = loginForm["login-password"].value.trim();
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) {
      loginError.textContent = err.message;
    }
  });

  // Ë®ªÂÜäË°®ÂñÆÊèê‰∫§
  registerForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    registerError.textContent = "";
    const email = registerForm["register-email"].value.trim();
    const password = registerForm["register-password"].value.trim();
    try {
      await createUserWithEmailAndPassword(auth, email, password);
    } catch (err) {
      registerError.textContent = err.message;
    }
  });

  // ÁôªÂá∫ÊåâÈàï
  logoutBtn.addEventListener("click", () => {
    signOut(auth);
  });
</script>
</body>
</html>